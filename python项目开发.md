# Djangoé¡¹ç›®å¼€å‘

## ä¸€. git åˆ›å»ºé¡¹ç›®

**æ·»åŠ sshå¯†é’¥**

```
swiper
 |- .gitignore (åˆ›å»ºçš„pythoné¡¹ç›®å¿½ç•¥æ–‡ä»¶)
 |- LICENSE
 |- README.md (é¡¹ç›®çš„å…¥é—¨æ‰‹å†Œ)
```

> README.mdæ–‡ä»¶æ˜¯ä¸€ä¸ªé¡¹ç›®çš„å…¥é—¨æ‰‹å†Œï¼Œé‡Œé¢ä»‹ç»äº†æ•´ä¸ªé¡¹ç›®çš„ä½¿ç”¨ã€åŠŸèƒ½ç­‰ç­‰ã€‚æ‰€ä»¥READMEæ–‡ä»¶å†™å¾—å¥½ä¸å¥½ï¼Œå…³ç³»åˆ°è¿™ä¸ªé¡¹ç›®èƒ½ä¸èƒ½æ›´å®¹æ˜“çš„è¢«å…¶ä»–äººäº†è§£å’Œä½¿ç”¨ã€‚
> READMEè‡³å°‘è¦å†™æ˜é¡¹ç›®çš„åŠŸèƒ½å’Œä½¿ç”¨ï¼Œè¿™æ˜¯æœ€åŸºæœ¬çš„ï¼Œå½“ç„¶ï¼Œä¸€ä¸ªå¥½çš„READMEæƒ³è¦çš„ä¸ä»…ä»…æ˜¯åŠŸèƒ½å’Œä½¿ç”¨æ–¹æ³•ã€‚å¥½çš„é¡¹ç›®éƒ½ä¼šæœ‰READMEï¼Œè¿™å·²ç»æ˜¯ä¸€ä¸ªçº¦å®šäº†ã€‚
> mdæ˜¯Markdownçš„ç¼©å†™ï¼Œå…¶å®READEMEå°±æ˜¯ä½¿ç”¨Markdownç¼–å†™çš„ã€‚READMEæ—¢ç„¶æ˜¯ä¸ºäº†è®©åˆ«äººäº†è§£ä½ è¿™ä¸ªé¡¹ç›®ï¼Œé‚£ä¹ˆåº”è¯¥å¦‚ä½•ç¼–å†™ï¼Ÿ
> å›½é™…åŒ–ï¼š
> æˆ‘ä»¬éƒ½çŸ¥é“GitHubä¸€èˆ¬éƒ½æ˜¯ä½¿ç”¨è‹±è¯­ï¼Œæ‰€ä»¥å¯ä»¥çš„è¯æœ€å¥½å†™ä¸¤ä¸ªç‰ˆæœ¬ï¼Œä¸€ä¸ªæ˜¯è‹±æ–‡ï¼Œä¸ºäº†æ‰€æœ‰äººèƒ½çœ‹æ‡‚ï¼Œå¦ä¸€ä¸ªæ˜¯ä¸­æ–‡ï¼Œä¸ºäº†æˆ‘ä»¬æ›´å¥½çš„ç†è§£ã€‚
> é¡¹ç›®ååŠç®€ä»‹ï¼š
> ç®€å•ä»‹ç»ä¸€ä¸‹è¿™ä¸ªé¡¹ç›®æ˜¯åšä»€ä¹ˆçš„ã€‚æœ‰çš„è¯æœ€å¥½åŠ ä¸Šdemoåœ°å€ã€‚
> åŠŸèƒ½ï¼š
> ä½ è¿™ä¸ªé¡¹ç›®å¯ä»¥å®ç°çš„åŠŸèƒ½ã€‚
> ç”¨æ³•ï¼š
> è¿™å¯ä»¥è¯´æ˜¯æœ€é‡è¦çš„ï¼Œä¸€å®šè¦è®©åˆ«äººçœ‹å¾—æ‡‚ä½ è¿™é¡¹ç›®æ˜¯æ€ä¹ˆä½¿ç”¨çš„ã€‚
> å…¶ä»–ï¼š
> ä½œè€…æˆ–è€…æ˜¯ç»´æŠ¤äººåˆ—è¡¨ã€ç‰ˆæƒã€é¸£è°¢ã€è´¡çŒ®ã€logoã€è”ç³»æ–¹å¼ç­‰ç­‰ï¼Œè¿™äº›æœ‰çš„è¯å½“ç„¶ä¼šæ›´åŠ é«˜å¤§ä¸Šã€‚ 

## äºŒ. åˆ›å»ºè™šæ‹Ÿç¯å¢ƒ

+ åœ¨é¡¹ç›®è·¯å¾„ä¸‹ç”¨å‘½ä»¤è¡Œåˆ›å»ºï¼ˆ**ä½¿ç”¨éº»çƒ¦**ï¼‰

```
windowsï¼š
python -m venv .venv ï¼ˆ1.åˆ›å»ºè™šæ‹Ÿç¯å¢ƒï¼‰
.venv/Scripts/activate ï¼ˆ2.æ¿€æ´»è™šæ‹Ÿç¯å¢ƒï¼‰
--------------------------------------------
mac/linuxï¼š
python -m venv .venv ï¼ˆ1.åˆ›å»ºè™šæ‹Ÿç¯å¢ƒï¼‰
source .venv/Scripts/activate ï¼ˆ2.æ¿€æ´»è™šæ‹Ÿç¯å¢ƒï¼‰
```

+ ç›´æ¥ç”¨Pycharmåˆ›å»ºï¼ˆ**ä½¿ç”¨æ–¹ä¾¿**ï¼‰

> å‹¾é€‰ä¸‹é¢è¿™ä¸ªé€‰é¡¹ï¼ˆè¿™æ ·æ¯æ¬¡æ‰“å¼€é¡¹ç›®ä¸ç”¨æ¿€æ´»è™šæ‹Ÿç¯å¢ƒï¼‰
>
> - [x] Make available to all projects
>
> ```
> where python/where pip æŸ¥æ‰¾pythonå’Œpipçš„ä½ç½®
> å¦‚æœpipä½¿ç”¨çš„è¿˜æ˜¯å…¨å±€å˜é‡çš„ï¼Œä½¿ç”¨ä¸‹é¢çš„æ–¹æ³•
> .venv\Scripts\python.exe -m pip list
> .venv\Scripts\python.exe -m pip install -r requirement.txt
> ```

## ä¸‰. å®‰è£…PythonåŒ…

```
pip install django redis gunicorn gevent celery ipython
```

å°†ç¯å¢ƒçš„åŒ…å¯¼å…¥**requirements.txt**æ–‡ä»¶

```
pip freeze > requirements.txt
```

## å››. åˆ›å»ºDjangoé¡¹ç›®

```
åœ¨ä¸‹ä¸€çº§åˆ›å»ºé¡¹ç›®ï¼š
django-admin startproject swiper
åœ¨å½“å‰ç›®å½•åˆ›å»ºé¡¹ç›®ï¼š
django-admin startproject swiper ./
```

é¡¹ç›®ç»“æ„ï¼š

```
swiper
 |- .venv/
 |- swiper/
 |- .gitignore
 |- LICENSE
 |- manage.py
 |- README.md
 |- requirement.txt
```

## äº”. useræ¨¡å—

```
manage.py startapp user
```

é¡¹ç›®ç»“æ„ï¼š

```
swiper
 |- .venv/
 |- swiper/
 |- user/
 |- .gitignore
 |- LICENSE
 |- manage.py
 |- README.md
 |- requirement.txt
```

```
è¿›å…¥ipythonè°ƒè¯•ç¯å¢ƒï¼š
manage.py shell
```

#### useræ¨¡å—ç»“æ„ï¼š

```
user
 |- migrations/
 |- __init__.py
 |- api.py
 |- apps.py
 |- logic.py
 |- models.py
 |- tests.py
```

###  1. modelsåˆ›å»º

#### @property(æè¿°ç¬¦) çš„ä½¿ç”¨

> `property`ç¬¬ä¸€ä¸ªå‚æ•°ä¸ºå®ä¾‹æœ¬èº«`self`ï¼Œæ‰€ä»¥ç±»å±æ€§å’Œå®ä¾‹å±æ€§éƒ½å¯ä»¥è®¿é—®åˆ°ã€‚

```python
class Box:
    def __init__(self):
        self.length = 123
        self.width = 10
        self.height = 80

    def volume(self):
        return self.length * self.width * self.height


b = Box()
v = b.volume()
print("ä½“ç§¯ä¸ºï¼š", v)

"""ä¿®æ”¹:@propertyå°†ç±»æ–¹æ³•å±æ€§åŒ–ï¼Œå¹¶ä¸”ä¸ºåªè¯»"""


class Box:
    def __init__(self):
        self.length = 123
        self.width = 10
        self.height = 80

    @property
    def volume(self):
        return self.length * self.width * self.height


b = Box()
print("ä½“ç§¯ä¸ºï¼š", b.volume)
```

#### `@classmethod` å’Œ`@staticmethod` åŒºåˆ«

> 1. è¯­æ³•åŒºåˆ«
>    + å£°æ˜æ—¶ï¼š 
>      + `classmethod`çš„ç¬¬ä¸€ä¸ªå‚æ•°ä¸ºç±»æœ¬èº«(`cls`)ï¼Œæ­£å¦‚å®ä¾‹æ–¹æ³•çš„ç¬¬ä¸€ä¸ªå‚æ•°ä¸ºå¯¹è±¡æœ¬èº«(self);
>      + `staticmethod`ç¬¬ä¸€ä¸ªå‚æ•°ä¸éœ€è¦ä¼ å…¥`cls`æˆ–`self`ï¼Œæ•…`staticmethod`ä¸­æ˜¯æ— æ³•è®¿é—®ç±»å’Œå¯¹è±¡çš„æ•°æ®çš„ã€‚
>    + è°ƒç”¨æ—¶ï¼š
>      + éƒ½å¯ç”¨ç±»åç›´æ¥è°ƒç”¨
>      + ä¹Ÿå¯ç”¨å®ä¾‹å¯¹è±¡è°ƒç”¨ï¼ˆä¸æ¨èï¼Œæ²¡å¿…è¦ï¼‰

```python
class A:
    z = 789

    def __init__(self):
        self.x = 123
        self.y = 456

    def foo1(self):
        print(self.x,self.y)

    @classmethod
    def foo2(cls):
        return cls.z

    @staticmethod
    def foo3():
        return 123

A.foo2()
Out[3]: 789
A.foo3()
Out[4]: 123
a = A()
a.foo2()
Out[6]: 789
a.foo3()
Out[7]: 123
```

> 2. ä½¿ç”¨åœºæ™¯
>    + ä¸¤è€…ç‰¹ç‚¹ï¼š
>      + `classmethod`å¯ä»¥è®¾ç½®ä¿®æ”¹ç±»å±æ€§ï¼›ä¹Ÿå¯ä»¥å®ä¾‹åŒ–å¯¹è±¡ï¼›
>      + `staticmethod`æ— æ³•è®¿é—®ç±»æˆ–å¯¹è±¡çš„æ•°æ®ï¼Œæ‰€ä»¥å¯æŠŠå®ƒå½“ä½œä¸€ä¸ªè¾…åŠ©åŠŸèƒ½æ–¹æ³•ç”¨ï¼Œé‡Œé¢åŒ…å«ä¸€äº›ä¸è¯¥ç±»æœ‰å…³çš„é€»è¾‘ä»£ç ã€‚æ¯”å¦‚`validate(*args)`
> 3. å®ä¾‹
>    +  éœ€æ±‚ï¼šä»æœ¬åœ°æ–‡ä»¶ä¸­`(txt, csv, jsonç­‰ç­‰)`è¯»å–æ•°æ®ï¼Œç”Ÿæˆä¸€ä¸ªå¯¹è±¡ã€‚æ¯”å¦‚ï¼Œæœ¬åœ°æœ‰ä¸€ä¸ª`data.json`æ–‡ä»¶ï¼Œé‡Œé¢åŒ…å«äº†æ¯ä¸ªå­¦ç”Ÿçš„å§“ååŠå¯¹åº”çš„è€ƒè¯•æˆç»©ã€‚ç°åœ¨è¦æ±‚è¯»å–è¯¥æ•°æ®ï¼Œç”Ÿæˆä¸€ä¸ªclasså¯¹è±¡ã€‚ 
>    + æ€è·¯
>      + `__init__`æ–¹æ³•ä¸­ï¼Œæ¸…æ™°çš„å£°æ˜å¯¹è±¡çš„å±æ€§
>      + ç”¨ä¸€ä¸ª`classmethod`ï¼š`load_json`ï¼Œä¸“é—¨ç”¨äºè¯»å–data_fileï¼Œè·å–æ•°æ®ï¼Œå®ä¾‹åŒ–å¯¹è±¡
>      + ç”¨ä¸€ä¸ª`staticmethod`ï¼š`validate`ï¼Œæ¥å¯¹è¦åˆå§‹åŒ–æ•°æ®è¿›è¡Œæœ‰æ•ˆæ€§æ£€æŸ¥

```python
class Class:
    def __init__(self, names, grades):
        self._names = names
        self._grades = grades

    @classmethod
    def load_json(cls, data_file):
        # è¯»å–æ•°æ®,è·å¾—names,grades
        cls.validate(namesï¼Œgrades)
        return cls(names, grades)

    @staticmethod
    def validate(names, grades):
        # æ£€æŸ¥æ•°æ®æœ‰æ•ˆæ€§
        pass

data_file = {'names':'fanxinde','grades':11}
obj = Class.load_json(data_file)
obj
Out[14]: <__main__.Class at 0x25319575f70>
obj._names
Out[15]: 'fanxinde'
obj._grades
Out[16]: 11
```

åŠ äº†ä¸€ç‚¹

```python
class Class:
    def __init__(self, names, grades):
        self._names = names
        self._grades = grades

    def read_names(self):
        return self._names

    @property
    def read_grades(self):
        return self._grades

    @classmethod
    def load_json(cls, data_file):
        # è¯»å–æ•°æ®,è·å¾—names,grades
        names = data_file.get('names')
        grades = data_file.get('grades')
        cls.validate(names, grades)
        return cls(names, grades)

    @staticmethod
    def validate(names, grades):
        # æ£€æŸ¥æ•°æ®æœ‰æ•ˆæ€§
        pass

data_file = {'names':'fanxinde','grades':11}
obj = Class.load_json(data_file)
obj.read_names()
Out[20]: 'fanxinde'
obj.read_grades
Out[21]: 11
```

æ€»ç»“ï¼š

1. `property`è£…é¥°çš„æ–¹æ³• ç»§æ‰¿ `self`ï¼Œå°†æ–¹æ³•ä»¥**å¯¹è±¡å±æ€§**çš„æ–¹å¼ä½¿ç”¨ï¼Œæ–¹æ³•è¿”å›ä¸€ä¸ªå€¼ï¼Œå³å¯¹è±¡.æ–¹æ³•ç›´æ¥å¾—åˆ°å€¼ï¼Œä¸éœ€è¦å†åŠ æ‹¬å·è°ƒç”¨ã€‚
2. ` classmethod `è£…é¥°çš„æ–¹æ³•ç»§æ‰¿`cls`ï¼Œå°†æ–¹æ³•å˜ä¸º**ç±»æ–¹æ³•**ä½¿ç”¨ï¼Œä¸éœ€è¦å®ä¾‹åŒ–ï¼Œç±»å¯ä»¥ç›´æ¥ä½¿ç”¨ï¼Œå½“ç„¶å¯¹è±¡ä¹Ÿå¯ä»¥ä½¿ç”¨ï¼Œä½†å°±å¤±å»äº†æ„ä¹‰ã€‚
3.  `staticmethod `è£…é¥°çš„æ–¹æ³•ä¸ç»§æ‰¿ï¼Œå°†æ–¹æ³•ä½œä¸º**ç±»æ–¹æ³•**ä½¿ç”¨ï¼Œ ä¸éœ€è¦å®ä¾‹åŒ–ï¼Œä¸è®¿é—®ç±»å’Œå¯¹è±¡çš„æ•°æ®ï¼Œå½“ç„¶å¯¹è±¡ä¹Ÿå¯ä»¥ä½¿ç”¨ï¼Œä½†å°±å¤±å»äº†æ„ä¹‰ã€‚
4. ç»§æ‰¿ self çš„éƒ½æ˜¯å®ä¾‹åŒ–ä¹‹åæ‰èƒ½ä½¿ç”¨ã€‚

#### æ„å»ºUseræ¨¡å‹

`models.py`

```python
from django.db import models
import datetime
from django.utils.functional import cached_property


class User(models.Model):
    """ç”¨æˆ·æ•°æ®æ¨¡å‹"""
    SEX = (
        ('ç”·', 'ç”·'),
        ('å¥³', 'å¥³'),
    )
    nickname = models.CharField(max_length=32, unique=True)
    phone = models.CharField(max_length=16, unique=True)

    sex = models.CharField(max_length=8, choices=SEX)
    avatar = models.CharField(max_length=256)
    location = models.CharField(max_length=32)
    birth_year = models.IntegerField(default=2000)
    birth_month = models.IntegerField(default=1)
    birth_day = models.IntegerField(default=1)

    # @property
    @cached_property  # djangoæä¾›çš„ç¼“å­˜è£…é¥°å™¨ï¼Œç›¸æ¯”äºpropertyçš„ä¼˜åŠ¿æ˜¯ï¼Œå¦‚æœå¯¹è±¡ç›¸åŒï¼Œç±»æ–¹æ³•åªæ‰§è¡Œä¸€æ¬¡ã€‚
    def age(self):
        today = datetime.date.today()
        birth_date = datetime.date(self.birth_year, self.birth_month, self.birth_day)
        times = today - birth_date
        return times.days // 365

    @property
    def profile(self):
        """ç”¨æˆ·çš„é…ç½®é¡¹"""
        # if '_profile' not in self.__dict__:
        # è¿™æ ·çš„è¯æŸ¥è¯¢åªéœ€è¦æ‰§è¡Œä¸€æ¬¡ï¼Œç”¨ç±»å±æ€§è®°ä½ï¼Œåªè¦selfè¿˜åœ¨å°±ä¸ä¼šæ¶ˆå¤±
        if not hasattr(self, '_profile'):
            self._profile, _ = Profile.objects.get_or_create(id=self.id)  # å¦‚æœæ²¡æœ‰ï¼Œåˆ™åˆ›å»º
        return self._profile


class Profile(models.Model):
    """ç”¨æˆ·é…ç½®é¡¹"""

    SEX = (
        ('ç”·', 'ç”·'),
        ('å¥³', 'å¥³'),
    )
    dating_sex = models.CharField(default="å¥³", max_length=8, choices=SEX, verbose_name='åŒ¹é…çš„æ€§åˆ«')
    location = models.CharField(max_length=32, verbose_name='ç›®æ ‡åŸå¸‚')

    min_distance = models.IntegerField(default=1, verbose_name='æœ€å°æŸ¥æ‰¾èŒƒå›´')
    max_distance = models.IntegerField(default=10, verbose_name='æœ€å¤§æŸ¥æ‰¾èŒƒå›´')

    min_dating_age = models.IntegerField(default=18, verbose_name='æœ€å°äº¤å‹å¹´é¾„')
    max_dating_age = models.IntegerField(default=45, verbose_name='æœ€å¤§äº¤å‹å¹´é¾„')

    vibration = models.BooleanField(default=True, verbose_name='æ˜¯å¦å¼€å¯éœ‡åŠ¨')
    only_match = models.BooleanField(default=True, verbose_name='ä¸è®©æœªåŒ¹é…çš„äººçœ‹æˆ‘çš„ç›¸å†Œ')
    only_play = models.BooleanField(default=True, verbose_name='æ˜¯å¦è‡ªåŠ¨æ’­æ”¾è§†é¢‘')
```

#### settingsè®¾ç½®

`settings.py`

```python
ALLOWED_HOSTS = ['*']

# ä¸éœ€è¦çš„å°±åˆ æ‰
INSTALLED_APPS = [
    'django.contrib.contenttypes',
    'django.contrib.sessions',
    'django.contrib.staticfiles',
    'user',
]

MIDDLEWARE = [
    'django.middleware.security.SecurityMiddleware',
    # 'common.middleware.CorsMiddleware' # æœ‰é—®é¢˜
    'django.contrib.sessions.middleware.SessionMiddleware',
    'django.middleware.common.CommonMiddleware',
    # 'django.middleware.csrf.CsrfViewMiddleware',  # ç›®å‰å¯æœ‰å¯æ— 
    'django.middleware.clickjacking.XFrameOptionsMiddleware',
]

TEMPLATES = [
    {
        'BACKEND': 'django.template.backends.django.DjangoTemplates',
        'DIRS': [],
        'APP_DIRS': True,
        'OPTIONS': {
            'context_processors': [
                'django.template.context_processors.debug',
                'django.template.context_processors.request',
            ],
        },
    },
]

LANGUAGE_CODE = 'zh-hans'

TIME_ZONE = 'Asia/Shanghai'
```

> `/user/admin.py` ä¹Ÿå¯ä»¥åˆ æ‰

#### è¡¨è¿ç§»

```
manage.py makemigrations
manage.py migrate
```

#### `__dict__`ï¼ˆç±»å­—å…¸ï¼‰

> åŒ…å«äº†è¿™ä¸ªå¯¹è±¡ä¸­çš„æ‰€æœ‰å±æ€§å’Œå±æ€§å€¼ï¼š`{key:value,key:value,key:value}`

#### `hasattr(obj,attr)`

> æ£€æŸ¥objå¯¹è±¡ä¸­æ˜¯å¦æœ‰attrå±æ€§ï¼Œç›¸å½“äº 
>
> ```python
> value = hasattr(obj,attr)
> value = True if attr not in obj.__dict__ else False
> ```

#### ä½¿ç”¨shellæ¥è¿›è¡Œmodelsçš„è°ƒè¯•

> è¿™æ ·åšçš„å¥½å¤„æ˜¯ä¸ç”¨ç­‰æ‰€æœ‰ä»£ç éƒ½å†™å®Œå†è¿›è¡Œè°ƒè¯•ï¼Œè¿™æ ·æ¯”è¾ƒé«˜æ•ˆ

#### cached_property

```python
from django.utils.functional import cached_property
@cached_property  # djangoæä¾›çš„ç¼“å­˜è£…é¥°å™¨ï¼Œç›¸æ¯”äºpropertyçš„ä¼˜åŠ¿æ˜¯ï¼Œå¦‚æœå¯¹è±¡ç›¸åŒï¼Œç±»æ–¹æ³•åªæ‰§è¡Œä¸€æ¬¡ã€‚
```

### 2. api (views)ç¼–å†™

+ å¯ä»¥å°† `views.py` æ”¹ä¸º `api.py`ï¼Œæ›´ç›´è§‚ï¼Œè¿™äº›æ–‡ä»¶å¯ä»¥éšä¾¿å‘½åã€‚

+ æ–°å¢ä¸€ä¸ªå†™é€»è¾‘ä»£ç çš„æ–‡ä»¶ `logic.py`ã€‚

+ æ–°å»ºä¸€ä¸ª`config.py`æ–‡ä»¶ï¼Œæ¥æ”¾ä¸Djangoæœ¬èº«æ— å…³çš„é…ç½®ï¼Œä¸å½±å“Djangoã€‚

#### `swiper/config.py`

é˜¿é‡Œäº‘çŸ­ä¿¡éªŒè¯ç ï¼š

```python
"""
ç¬¬ä¸‰æ–¹é…ç½®
"""

# é˜¿é‡Œäº‘çŸ­ä¿¡é…ç½®
ALI_SMS_PARAMS = {'AccessKeyId': 'LTAI5tN3SSefoMm8fGwnZzni',
                  'AccessKeySecret': 'rJCzRj0K8V8nck0OjVlxAgWv5juFWO',
                  'sign_name': 'é˜¿é‡Œäº‘çŸ­ä¿¡æµ‹è¯•',
                  'template_code': 'SMS_154950909',
                  'phone_numbers': '',
                  'template_param': '',  # '{"code":"1234"}'
                  }
```

```python
request.GET
request.POST
# éƒ½æ˜¯å­—å…¸
```

#### `user/api.py`

```python
from libs.http import render_json
from .logic import send_verify_code, check_vcode
from common import error
from user.models import User


def get_verify_code(request):
    """æ‰‹æœºæ³¨å†Œ"""
    phonenum = request.GET.get('phonenum')
    send_verify_code(phonenum)
    return render_json(phonenum, 0)


def login(request):
    """çŸ­ä¿¡éªŒè¯ç ç™»å½•"""
    phonenum = request.POST.get('phonenum')
    vcode = request.POST.get('vode')
    if check_vcode(phonenum, vcode):
        # è·å–ç”¨æˆ·
        user, created = User.objects.get_or_create(phonenum=phonenum)

        # è®°å½•ç™»é™†çŠ¶æ€
        request.session['uid'] = user.id
        return render_json(user.to_dict(), 0)
    else:
        return render_json(phonenum, error.VCODE_ERROR)


def get_profile(request):
    """è·å–ä¸ªäººèµ„æ–™"""
    pass


def modify_profile(request):
    """ä¿®æ”¹ä¸ªäººèµ„æ–™"""
    pass


def upload_avatar(request):
    """å¤´åƒä¸Šä¼ """
    pass
```

> ç¼“å­˜å’Œsession

```python
cache.set(key, vcode, 1800)  # è®¾ç½®ç¼“å­˜
saved_vcode = cache.get(key)  # getç¼“å­˜

request.session['uid'] = user.id  # è®¾ç½®session
```

#### `user/logic.py`

```python
import random

from alibabacloud_dysmsapi20170525 import models as dysmsapi_20170525_models
from alibabacloud_dysmsapi20170525.client import Client as Dysmsapi20170525Client
from alibabacloud_tea_openapi import models as open_api_models
from alibabacloud_tea_util import models as util_models
from django.core.cache import cache

from swiper.config import ALI_SMS_PARAMS
from worker import call_by_worker


def gen_verify_code(length=6):
    return random.randrange(10 ** (length - 1), 10 ** length)


@call_by_worker
def send_verify_code(phonenum):
    """å¼‚æ­¥å‘é€éªŒè¯ç """
    vcode = gen_verify_code()
    key = 'VerifyCode-%s' % phonenum
    cache.set(key, vcode, 1800)
    sms_cfg = ALI_SMS_PARAMS.copy()
    sms_cfg['phone_numbers'] = phonenum
    sms_cfg['template_param'] = '{"code":"%s"}' % vcode
    response = Sample.main(sms_cfg)
    return response


def check_vcode(phonenum, vcode):
    """æ£€æŸ¥éªŒè¯ç æ˜¯å¦æ­£ç¡®"""
    key = 'VerifyCode-%s' % phonenum
    saved_vcode = cache.get(key)
    return str(saved_vcode) == str(vcode)


class Sample:
    def __init__(self):
        pass

    @staticmethod
    def create_client(
            access_key_id: str,
            access_key_secret: str,
    ) -> Dysmsapi20170525Client:
        """
        ä½¿ç”¨AK&SKåˆå§‹åŒ–è´¦å·Client
        @param access_key_id:
        @param access_key_secret:
        @return: Client
        @throws Exception
        """
        config = open_api_models.Config(
            # æ‚¨çš„ AccessKey ID,
            access_key_id=access_key_id,
            # æ‚¨çš„ AccessKey Secret,
            access_key_secret=access_key_secret
        )
        # è®¿é—®çš„åŸŸå
        config.endpoint = f'dysmsapi.aliyuncs.com'
        return Dysmsapi20170525Client(config)

    @staticmethod
    def main(
            args: dict,
    ):
        client = Sample.create_client(args.get('AccessKeyId'), args.get('AccessKeySecret'))
        send_sms_request = dysmsapi_20170525_models.SendSmsRequest(
            sign_name=args.get('sign_name'),
            template_code=args.get('template_code'),
            phone_numbers=args.get('phone_numbers'),
            template_param=args.get('template_param')
        )
        runtime = util_models.RuntimeOptions()
        # å¤åˆ¶ä»£ç è¿è¡Œè¯·è‡ªè¡Œæ‰“å° API çš„è¿”å›å€¼
        response = client.send_sms_with_options(send_sms_request, runtime)
        return response.body.code


if __name__ == '__main__':
    send_verify_code('17835699470')
```

#### `user/forms.py`

```python
from django import forms

from user.models import User


class ProfileForm(forms.ModelForm):
    class Meta:
        model = User
        fields = ['dating_sex', 'location', 'min_distance',
                  'max_distance', 'min_dating_age', 'max_dating_age',
                  'vibration', 'only_match', 'only_play']

```

> Formè¡¨å•å¯ä»¥å¾ˆæ–¹ä¾¿çš„å°†å‰ç«¯ä¼ è¿‡æ¥çš„`request.POST`å­—å…¸æ•°æ®è¿›è¡Œæ ¡éªŒï¼Œå› ä¸ºå…¶é€šè¿‡Metaä¸modelå…³è”

```
form_obj.is_valid()  # éªŒè¯æ•°æ®æ˜¯å¦éƒ½æ­£ç¡®
form_obj.errors  # è¾“å‡ºé”™è¯¯çš„å­—æ®µåŠåŸå› 
form_obj.cleaned_data  # å°†æ¸…æ´—åçš„æ•°æ®ä»¥å­—å…¸å½¢å¼è¾“å‡º
form_obj.save()   # å°†è¡¨å•éªŒè¯åçš„æ•°æ®æ ¹æ®æ ¹æ®å…³è”çš„modelä¿å­˜åˆ°æ•°æ®åº“
```

> è¡¨å•ä¾‹å­ğŸ‘‡

```python
class TestForm(Form):
   ...:     TAGS = (
   ...:         ('py', 'python'),
   ...:         ('ln', 'linux'),
   ...:         ('dj', 'django'),
   ...:     )
   ...:     fid = IntegerField()
   ...:     name = CharField(max_length=10)
   ...:     tag = ChoiceField(choices=TAGS)
   ...:     date = DateField()
   ...:     
POST = {'fid':'123','name':'sdfsdfsd','tag':'dj','date':'2017-01-01'}
form = TestForm(POST)
form.is_valid()
Out[14]: True

form.errors
Out[27]: {}

form.cleaned_data
Out[28]: 
{'fid': 123,
 'name': 'sdfsdfsd',
 'tag': 'dj',
 'date': datetime.date(2017, 1, 1)}
```

## å…­. celery

#### celeryæ¨¡å—ç»“æ„ï¼š

```
worker
 |- __init__.py
 |- config.py
```

`__init__.py`

```python
import os
from celery import Celery

# 1. è®¾ç½®ç¯å¢ƒå˜é‡ï¼ŒåŠ è½½ Django çš„ settings
# Set the default Django settings module for the 'celery' program.
os.environ.setdefault('DJANGO_SETTINGS_MODULE', 'swiper.settings')


# 2. åˆ›å»º Celery Application
celery_app = Celery('swiper')
celery_app.config_from_object('worker.config')  # 3. åŠ è½½celeryé…ç½®æ–‡ä»¶
celery_app.autodiscover_tasks()  # 4. è‡ªåŠ¨å‘ç°é€šè¿‡è£…é¥°å™¨å®šä¹‰çš„æ‰€æœ‰ä»»åŠ¡


def call_by_worker(func):
    """å°†ä»»åŠ¡åœ¨ Celery ä¸­å¼‚æ­¥æ‰§è¡Œ, åªéœ€è¦å°†æ­¤å‡½æ•°ä½œä¸ºè£…é¥°å™¨ä½¿ç”¨ï¼Œå°±å¯ä»¥å…å»ä¸€äº›é¢‘ç¹çš„æ“ä½œ"""
    task = celery_app.task(func)
    # task.delay å°†taskåŠ åˆ°å¼‚æ­¥ä»»åŠ¡é‡Œé¢
    return task.delay
```

`config.py`

```
# é…ç½®ä»£ç†äººï¼ŒæŒ‡å®šä»£ç†äººå°†ä»»åŠ¡å­˜åˆ°å“ªé‡Œ,è¿™é‡Œæ˜¯redisçš„0å·åº“
broker_url = 'redis://127.0.0.1:6379/0'
broker_pool_limit = 1000

# è®¾ç½®æ—¶åŒºï¼Œé»˜è®¤UTC
timezone = 'Asia/Shanghai'
# using serializer name
accept_content = ['pickle', 'json']

task_serializer = 'pickle'

result_backend = 'redis://127.0.0.1:6379/1'
result_serializer = 'pickle'
result_cache_max = 10000  # ä»»åŠ¡ç»“æœæœ€å¤§ç¼“å­˜æ•°é‡
result_expires = 3600  # ä»»åŠ¡ç»“æœçš„è¿‡æœŸæ—¶é—´

worker_redirect_stdouts_level = 'INFO'
```

```
windowsï¼š
celery -A task worker --loglevel=info -P eventlet
linux/mac
celery -A task worker --loglevel=info
taskï¼šceleryä»»åŠ¡æ¨¡å—å
```

> ä¼šé‡åˆ°çš„é—®é¢˜ï¼š
>
> 1. å¯åŠ¨celeryæ²¡æœ‰ tasks åˆ—è¡¨æ²¡æœ‰ä»»åŠ¡ï¼ŒCeleryæ²¡æœ‰æ‰«æåˆ°Djangoé‡Œçš„æ‰€æœ‰å‡½æ•°ï¼Œè§£å†³æ–¹æ³•ï¼šå°†ä»»åŠ¡æ‰€åœ¨æ¨¡å—çš„è·¯ç”±æ·»åŠ ä¸Šã€‚
> 2. Windowsç³»ç»Ÿceleryå¯åŠ¨ä»»åŠ¡ä¸æ‰§è¡Œï¼Œè§£å†³æ–¹æ³•ï¼šå°†celeryå¯åŠ¨å‘½ä»¤è¡ŒåŠ ä¸Š -P eventletã€‚
> 3. è°ƒè¯•celeryæ—¶ï¼Œä½¿ç”¨Shellï¼Œæ–¹ä¾¿å¿«æ·ã€‚

https://docs.celeryq.dev/en/stable/django/first-steps-with-django.html#using-celery-with-django

#### è£…é¥°å™¨

```python
@celery_app.task
def add(x, y):
	return x + y
--è£…é¥°å™¨å°±æ˜¯å‡½æ•°ï¼Œå°†è£…é¥°çš„å‡½æ•°ä½œä¸ºå‚æ•°æ‰§è¡Œä»¥åçš„è¿”å›å€¼èµ‹å€¼ç»™ç›¸åŒçš„å‡½æ•°å--
add = celery_app.task(add)
```

```python
def deco(func):
    def wrap(*args, **kwargs):
        r = func(*args, **kwargs)
        return r

    return wrap


def bar(x, y):
    return x * y


@deco
def par(x, y):
    return x * y


@deco
def par1(x, y):
    return x * y
------------------------
bar
Out[5]: <function __main__.bar(x, y)>
par
Out[6]: <function __main__.deco.<locals>.wrap(*args, **kwargs)>
par1
Out[7]: <function __main__.deco.<locals>.wrap(*args, **kwargs)>
bar = deco(bar)
bar
Out[9]: <function __main__.deco.<locals>.wrap(*args, **kwargs)>
```

## ä¸ƒ. libsæ¨¡å—

> æ–°å»ºä¸€ä¸ªlibraryåŒ…ï¼Œç”¨æ¥å­˜æ”¾ååº•å±‚çš„ä¸€äº›æ–¹æ³•

### 1. `http.py`

+ `render_json` ï¼šå°†æ¥å£è¿”å›è¿›è¡ŒåŒ…è£…

```python
import json

from django.conf import settings
from django.http import HttpResponse


def render_json(data, code=0):
    result = {
        'code': code,
        'data': data
    }
    if settings.DEBUG:
        # å¦‚æœä¸ºDEBUGæ¨¡å¼ï¼Œæ­£å¸¸è¾“å‡ºjsonæ ¼å¼ï¼Œå¦‚æœä¸æ˜¯DEBUGï¼Œå‹ç¼©åè¾“å‡º
        json_str = json.dumps(result, ensure_ascii=False, indent=4, sort_keys=True)  # indent ç¼©è¿›ï¼Œsort_keys æ’åº
    else:
        json_str = json.dumps(result, ensure_ascii=False, separators=[',', ':'])
    return HttpResponse(json_str)

```

### 2. `orm.py`

> `orm`ç›¸å…³çš„æ–¹æ³•: 

+ `ModelMixin`
  + `to_dict`ï¼šå°† model å¯¹è±¡è½¬åŒ–ä¸º dict

#### å¤šæ€

```shell
  ...: class Animal:
  ...:     def run(self):
  ...:         print('Animal running')
  ...: 
  ...: class Lion:
  ...:     def run(self):
  ...:         print('Lion running')
  ...: 
  ...: class Tiger:
  ...:     def run(self):
  ...:         print('Tiger running')
  ...: 
  ...: class LeoTiger(Lion, Tiger):
  ...:     pass
  ...: cub = LeoTiger()
isinstance(cub,Lion)
Out[3]: True
isinstance(cub,Tiger)
Out[4]: True
LeoTiger.mro()
Out[5]: [__main__.LeoTiger, __main__.Lion, __main__.Tiger, object]
```

#### å¤šç»§æ‰¿

+ æ–¹æ³•å’Œå±æ€§çš„ç»§æ‰¿é¡ºåºï¼š`cls.mro()`

+ è±å½¢ç»§æ‰¿é—®é¢˜ï¼š

```
ç»§æ‰¿å…³ç³»ç¤ºæ„
è±å½¢ç»§æ‰¿
	A.foo()
  /   \
 B     C.foo()
  \   /
	D.foo()  # æ–¹æ³•çš„ç»§æ‰¿é¡ºåºï¼Œç”± C3 ç®—æ³•å¾—åˆ°
```

+ `Mixin`ï¼šé€šè¿‡å•çº¯çš„mixinç±»å®ŒæˆåŠŸèƒ½ç»„åˆï¼Œæ‰€æœ‰ç»§æ‰¿çš„ç±»çš„åŠŸèƒ½ä¸ä¼šæœ‰ä»»ä½•çš„äº¤å‰
  + ç»§æ‰¿çš„æ‰€æœ‰çš„çˆ¶ç±»ä¹‹é—´æ²¡æœ‰ä»»ä½•çš„æ–¹æ³•å’Œå±æ€§æœ‰é‡åˆ
  + ç»§æ‰¿çš„æ‰€æœ‰çš„çˆ¶ç±»ä»…ç”¨æ¥ç»§æ‰¿ä½¿ç”¨ï¼Œçˆ¶ç±»è‡ªèº«ä¸ä¼šåˆ›å»ºä»»ä½•å®ä¾‹

> `self._meta.fields`ï¼Œå°†å¯¹è±¡çš„ç±»å±æ€§åˆ—å‡ºæ¥ï¼ˆä¸åŒ…æ‹¬ä¹‹åè®¾ç½®çš„å¯¹è±¡å±æ€§ï¼‰
>
> `field.attname`ï¼Œå¾ªç¯ä¸Šé¢çš„å±æ€§ï¼Œç”¨attnameå±•ç¤ºå‡ºæ¥
>
> `obj.__dict__`ï¼Œå°†objçš„å±æ€§å’Œå±æ€§å€¼ä»¥å­—å…¸å½¢å¼åˆ—å‡ºæ¥
>
> `getattr(obj, attr)`ï¼Œè·å–objå¯¹è±¡çš„attrå±æ€§çš„å€¼
>
> `setattr(obj, attr, value)`ï¼Œè®¾ç½®objå¯¹è±¡çš„attrå±æ€§å€¼ä¸ºvalue
>
> `hasattr(obj, attr)`ï¼Œåˆ¤æ–­objå¯¹è±¡æœ‰æ²¡æœ‰attrå±æ€§ï¼Œå¦‚æœæœ‰ä¸ºTrueï¼Œå¦åˆ™ä¸ºFlase

`ModelMixin`

```python
class ModelMixin:
    def to_dict(self):
        """å°† model å¯¹è±¡è½¬åŒ–ä¸º dict"""
        data = {}
        for field in self._meta.fields:
            name = field.attname
            # value = self.__dict__[name]  # è¿™ä¸ªæ–¹æ³•ååº•å±‚
            value = getattr(self,name)
            data[name] = value
        return data
```

`models.py`

```python
from libs.orm import ModelMixin
class Profile(models.Model, ModelMixin):
    """ç”¨æˆ·é…ç½®é¡¹"""
	...
---------shell---------
profile = Profile.objects.last()
profile.to_dict()
Out[10]: 
{'id': 2,
 'dating_sex': 'å¥³',
 'location': '',
 'min_distance': 1,
 'max_distance': 10,
 'min_dating_age': 18,
 'max_dating_age': 45,
 'vibration': True,
 'only_match': True,
 'only_play': True}
```

### 3. `qncloud.py`

```python
from qiniu import Auth, put_file, etag
from swiper import config
from worker import call_by_worker

# æ„å»ºé‰´æƒå¯¹è±¡
qn = Auth(config.QN_ACCESSKEY, config.QN_SECRETKEY)


def upload_to_qiniu(localfile, key):
    """
    å°†æœ¬åœ°æ–‡ä»¶ä¸Šä¼ åˆ°ä¸ƒç‰›äº‘
    Args:
        localfile: è¦ä¸Šä¼ æ–‡ä»¶çš„æœ¬åœ°è·¯å¾„
        key: ä¸Šä¼ åˆ°ä¸ƒç‰›åä¿å­˜çš„æ–‡ä»¶å
    """
    bucket_name = config.QN_BUCKET_NAME  # è¦ä¸Šä¼ çš„ç©ºé—´
    token = qn.upload_token(bucket_name, key, 3600)  # ç”Ÿæˆä¸Šä¼  Tokenï¼Œå¯ä»¥æŒ‡å®šè¿‡æœŸæ—¶é—´ç­‰

    ret, info = put_file(token, key, localfile, version='v2')
    print(info)
    return ret, info


# æ‰‹åŠ¨è£…é¥°ä¸€æ¬¡ï¼Œå®šä¹‰å‡ºå¼‚æ­¥ä¸Šä¼ åˆ°ä¸ƒç‰›äº‘ï¼Œä¸ºäº†ä¸å½±å“åŸæ¥çš„æ–¹æ³•ï¼Œä¾¿äºè°ƒè¯•
async_upload_to_qiniu = call_by_worker(upload_to_qiniu)

```

### 4. `db.py`

> å¯¹Djangoçš„modelsè¿›è¡Œæ‰“è¡¥ä¸å¤„ç†ï¼Œæ¥å®ç°è‡ªåŠ¨ç¼“å­˜çš„ç›®çš„ï¼ˆæš‚æ—¶æ²¡ä½¿ç”¨ï¼‰

```python
from django.core.cache import cache
from django.db import models


def get(cls, *args, **kwargs):
    """æ•°æ®ä¼˜å…ˆä»ç¼“å­˜ä¸­è·å–ï¼Œç¼“å­˜ä¸­å–ä¸åˆ°å†ä»æ•°æ®åº“ä¸­è·å–"""
    # åˆ›å»º key
    pk = kwargs.get('pk') or kwargs.get('id')

    # ä»ç¼“å­˜ä¸­è·å–
    if pk is not None:
        key = 'Model-%s-%s' % (cls.__name__, pk)
        model_pbj = cache.get(key)
        if isinstance(model_pbj, cls):
            return model_pbj

    # ç¼“å­˜é‡Œé¢æ²¡æœ‰ï¼Œç›´æ¥ä»æ•°æ®åº“è·å–ï¼ŒåŒæ—¶å†™å…¥ç¼“å­˜
    model_pbj = cls.objects.get(*args, **kwargs)
    key = 'Model-%s-%s' % (cls.__name__, model_pbj.pk)
    cache.set(key, model_pbj)
    return model_pbj


def get_or_create(cls, *args, **kwargs):
    # åˆ›å»º key
    pk = kwargs.get('pk') or kwargs.get('id')

    # ä»ç¼“å­˜ä¸­è·å–
    if pk is not None:
        key = 'Model-%s-%s' % (cls.__name__, pk)
        model_pbj = cache.get(key)
        if isinstance(model_pbj, cls):
            return model_pbj, False

    # æ‰§è¡ŒåŸç”Ÿæ–¹æ³•ï¼Œå¹¶æ·»åŠ ç¼“å­˜
    model_pbj, created = cls.objects.save(*args, **kwargs)
    key = 'Model-%s-%s' % (cls.__name__, model_pbj.pk)
    cache.set(key, model_pbj)
    return model_pbj, created


def save(self, force_insert=False, force_update=False, using=None, update_fields=None):
    """å­˜å…¥æ•°æ®åº“åï¼ŒåŒæ—¶å†™å…¥ç¼“å­˜"""
    # åŸç”Ÿçš„ save ä»¥åŠè¢«ä¿®æ”¹ä¸ºäº† _origin_saveï¼Œæ‰€ä»¥å®é™…ä¸Šè¿˜æ˜¯å…ˆç”¨åŸç”Ÿçš„saveä¿å­˜ä¸€ä¸‹
    self._origin_save(force_insert=False, force_update=False, using=None, update_fields=None)
    key = 'Model-%s-%s' % (self.__class__.__name__, self.pk)
    cache.set(key, self)


def patch_model():
    """
    åŠ¨æ€æ›´æ–° Model æ–¹æ³•

    Model åœ¨ Django ä¸­æ˜¯ä¸€ä¸ªç‰¹æ®Šçš„ç±»ï¼Œå¦‚æœé€šè¿‡ç»§æ‰¿çš„æ–¹æ³•æ¥å¢åŠ æˆ–ä¿®æ”¹åŸæœ‰æ–¹æ³•ï¼ŒDjango ä¼šå°†
    ç»§æ‰¿çš„ç±»è¯†åˆ«ä¸ºä¸€ä¸ªæ™®é€šçš„ app.modelï¼Œæ‰€ä»¥åªèƒ½é€šè¿‡ monkey patchï¼ˆçŒ´å­è¡¥ä¸ï¼‰ çš„æ–¹å¼åŠ¨æ€ä¿®æ”¹
    """
    # åŠ¨æ€æ·»åŠ ä¸€ä¸ªç±»æ–¹æ³• get
    models.Model.get = classmethod(get)
    models.Model.get_or_create = classmethod(get_or_create)

    # ä¿®æ”¹saveï¼Œéœ€è¦æ”¹ä¸€ä¸‹åŸç”Ÿçš„ï¼Œä¸ç†è§£
    models.Model._origin_save = models.Model.save
    models.Model.save = save

```

éœ€è¦åœ¨`swiper/_init_.py`æ–‡ä»¶å¯¼å…¥

## å…«. commonæ¨¡å—æ·»åŠ 

> é€šå¸¸ç”¨çš„ä¸€äº›æ–‡ä»¶

### 1. `middleware.py`

+ `CorsMiddleware`ï¼šä¸é‡è¦ï¼Œä¸€èˆ¬æ˜¯å‰ç«¯è§£å†³ï¼ˆè¿™é‡Œå¤„ç†çš„æœ‰é—®é¢˜ï¼‰ã€‚
+ `AuthMiddleware`ï¼šè®¤è¯ä¸­é—´ä»¶ï¼Œçœå»æ¯æ¬¡è°ƒç”¨æ¥å£çš„è®¤è¯æ“ä½œã€‚

```python
from django.shortcuts import redirect
from django.utils.deprecation import MiddlewareMixin
from django.http import HttpResponse

from common import error
from libs.http import render_json
from user.models import User


class AuthMiddleware(MiddlewareMixin):
    """ç”¨æˆ·ç™»å½•è®¤è¯"""
    WHITE_LIST = [
        'api/user/verify',
        'api/user/login',
    ]

    def process_request(self, request):
        # å¦‚æœè¯·æ±‚çš„urlå¼€å¤´åœ¨ç™½åå•å†…ï¼Œç›´æ¥è·³è¿‡æ£€æŸ¥
        for path in self.WHITE_LIST:
            if request.path.startwith(path):  # pathåœ¨request.pathçš„å¼€å¤´æˆ–ç­‰äº
                return
        # è¿›è¡Œç™»é™†æ£€æŸ¥
        uid = request.session.get('uid')
        if uid:
            try:
                request.user = User.objects.get(id=uid)
                return
            except User.DoesNotExist:
                request.session.flush()  # æ¸…ç©ºsession
        return render_json(None, code=error.LOGIN_ERROR)


class CorsMiddleware(MiddlewareMixin):
    """å¤„ç†å®¢æˆ·ç«¯ JS çš„è·¨åŸŸ"""

    def process_request(self, request):
        if request.method == 'OPTIONS' and 'HTTP_ACCESS_CONTROL_REQUEST_METHOD' in request.META:
            response = HttpResponse()
            response['Content-Length'] = '0'
            response['Access-Control-Allow-Headers'] = request.META
            ['HTTP_ACCESS_CONTROL_REQUEST_HEADERS']
            response['Access-Control-Allow-Origin'] = 'http://127.0.0.1:8000'
            return response

    def process_response(self, request, response):
        response['Access-Control-Allow-Origin'] = 'http://127.0.0.1:8000'
        response['Access-Control-Allow-Credentials'] = 'true'
        return response

```

> `settings.py` æ·»åŠ 

```python
MIDDLEWARE = [
    'django.middleware.security.SecurityMiddleware',  # å®‰å…¨ä¸­é—´ä»¶
    # 'common.middleware.CorsMiddleware' # æœ‰é—®é¢˜
    'django.contrib.sessions.middleware.SessionMiddleware',  # sessionä¸­é—´ä»¶
    'django.middleware.common.CommonMiddleware',
    # 'django.middleware.csrf.CsrfViewMiddleware',  # ç›®å‰å¯æœ‰å¯æ— 
    'django.middleware.clickjacking.XFrameOptionsMiddleware',
    'common.middleware.AuthMiddleware',  # è®¤è¯ä¸­é—´ä»¶ï¼Œæ”¾åˆ°åé¢
]
```

### 2. `error.py`

> ä¸€äº›é”™è¯¯çš„å€¼
>
> ```python
> VCODE_ERROR = 1000  # éªŒè¯ç é”™è¯¯
> LOGIN_ERROR = 1001  # ç™»å½•é”™è¯¯
> PROFILE_ERROR = 1002  # å‰ç«¯ä¼ å…¥profileæ•°æ®æ²¡æœ‰é€šè¿‡éªŒè¯
> FILE_NOT_FOUND = 1003  # ä¸Šä¼ çš„æ–‡ä»¶ä¸å­˜åœ¨
> NOT_HAS_PERM = 1004  # ç”¨æˆ·æ²¡æœ‰è¯¥æƒé™
> ```

```python
from libs.orm import ModelMixin
class Profile(models.Model, ModelMixin):
    """ç”¨æˆ·é…ç½®é¡¹"""
	...
---------shell---------
profile = Profile.objects.last()
profile.to_dict()
Out[10]: 
{'id': 2,
 'dating_sex': 'å¥³',
 'location': '',
 'min_distance': 1,
 'max_distance': 10,
 'min_dating_age': 18,
 'max_dating_age': 45,
 'vibration': True,
 'only_match': True,
 'only_play': True}
```

## ä¹. é™æ€æ–‡ä»¶å¤„ç†

> 1. ç”¨æˆ·å›¾ç‰‡ä¸Šä¼ æœåŠ¡å™¨
> 2. æœåŠ¡å™¨å°†å›¾ç‰‡ä¸Šä¼ åˆ°ä¸ƒç‰›äº‘
> 3. å°†ä¸ƒç‰›äº‘è¿”å›çš„å›¾ç‰‡URLå­˜å…¥æ•°æ®åº“

## å. socialæ¨¡å—

```
manage.py startapp social
or
python manage.py startapp social
```

**randomåŒ…**

```python
random.randrange(1, 10)  # å·¦é—­å³å¼€åŒºé—´ï¼Œä¸åŒ…å«10
random.randint(1, 10)  # å·¦å³é—­åŒºé—´ï¼ŒåŒ…å«10
random.random()
random.choice(['a', 'b'])  # ä»ä¸€ä¸ªåºåˆ—é‡Œé¢é€‰æ‹©ä¸€ä¸ª,å¯ä»¥æ˜¯å­—ç¬¦ä¸²
random.sample('123456789', 3)   # é‡‡æ ·ï¼Œä»é‡Œé¢éšæœºä¸‰ä¸ªï¼Œå¯ä»¥æ˜¯å­—ç¬¦ä¸²
l = ['4', '2', '6', '5', '1', '9', '7', '3', '8']
random.shuffle(l)  # å°†læ‰“ä¹±ï¼Œä¸èƒ½æ˜¯å­—ç¬¦ä¸²
```

### 1. `social/api.py`

```python
from libs.http import render_json

from social import logic
from social.models import Friend
from vip.logic import perm_require


def get_users(request):
    """è·å–æ¨èåˆ—è¡¨"""
    group_num = int(request.GET.get('group_num', 0))
    start = group_num * 5
    end = start + 5
    users = logic.get_rcmd_users(request.user)[start:end]  # åˆ‡ç‰‡ï¼Œæƒ°æ€§åŠ è½½
    result = [user.to_dict() for user in users]
    return render_json(result)


def like(request):
    """å–œæ¬¢"""
    sid = int(request.POST.get('sid'))
    is_matched = logic.like(request.user, sid)
    return render_json({'is_matched': is_matched})


# perm_require('superlike')(superlike)(request)
@perm_require('superlike')
def superlike(request):
    """è¶…çº§å–œæ¬¢"""
    sid = int(request.POST.get('sid'))
    is_matched = logic.superlike(request.user, sid)
    return render_json({'is_matched': is_matched})


def dislike(request):
    """ä¸å–œæ¬¢"""
    sid = int(request.POST.get('sid'))
    logic.dislike(request.user, sid)
    return render_json(None)


@perm_require('rewind')
def rewind(request):
    """åæ‚”"""
    sid = int(request.POST.get('sid'))
    logic.rewind(request.user, sid)
    return render_json(None)


def friends(request):
    """æŸ¥è¯¢å¥½å‹"""
    my_friends = Friend.friends(request.user.id)
    friends_info = [friend.to_dict() for friend in my_friends]
    return render_json({'friends':friends_info})

```

### 2. `social/logic.py`

```python
import datetime

from social.models import Swiperd, Friend
from user.models import User


def get_rcmd_users(user):
    """è·å–æ¨èç”¨æˆ·"""
    sex = user.profile.dating_sex
    location = user.profile.location
    min_age = user.profile.min_dating_age
    max_age = user.profile.max_dating_age

    current_year = datetime.date.today().year
    min_year = current_year - min_age
    max_year = current_year - max_age

    users = User.objects.filter(sex=sex, location=location,
                                birth_year__gte=max_year, birth_year__lte=min_year)
    return users


def like(user, sid):
    """å–œæ¬¢ä¸€ä¸ªç”¨æˆ·"""
    Swiperd.mark(user.id, sid, 'like')
    # æ£€æŸ¥è¢«æ»‘åŠ¨çš„ç”¨æˆ·æ˜¯å¦å–œæ¬¢è¿‡è‡ªå·±
    if Swiperd.is_liked(uid=sid, sid=user.id):
        Friend.be_friends(uid1=user.id, uid2=sid)
        return True
    else:
        return False


def superlike(user, sid):
    """è¶…çº§å–œæ¬¢ä¸€ä¸ªç”¨æˆ·"""
    Swiperd.mark(user.id, sid, 'superlike')
    # æ£€æŸ¥è¢«æ»‘åŠ¨çš„ç”¨æˆ·æ˜¯å¦å–œæ¬¢è¿‡è‡ªå·±
    if Swiperd.is_liked(uid=sid, sid=user.id):
        Friend.be_friends(uid1=user.id, uid2=sid)
        return True
    else:
        return False


def dislike(user, sid):
    """ä¸å–œæ¬¢ä¸€ä¸ªç”¨æˆ·"""
    Swiperd.mark(user.id, sid, 'dislike')


def rewind(user, sid):
    """åæ‚”"""
    try:
        # å–æ¶ˆæ»‘åŠ¨è®°å½•
        Swiperd.objects.get(uid=user.id, sid=sid).delete()
    except Swiperd.DoesNotExist:
        pass
    # æ’¤é”€å¥½å‹å…³ç³»
    Friend.break_off(user.id, sid)

```

### 3. `social/models.py`

```python
from django.db import models
from django.db.models import Q

from user.models import User


class Swiperd(models.Model):
    STATUS = (
        ('superlike', 'è¶…çº§å–œæ¬¢'),
        ('like', 'å–œæ¬¢'),
        ('dislike', 'ä¸å–œæ¬¢'),
    )
    uid = models.IntegerField(verbose_name='æ»‘åŠ¨è€…çš„ UID')
    sid = models.IntegerField(verbose_name='è¢«æ»‘åŠ¨è€…çš„ UID')
    status = models.CharField(max_length=32, choices=STATUS)
    time = models.DateTimeField(auto_now_add=True)

    @classmethod
    def mark(cls, uid, sid, status):
        """æ ‡è®°ä¸€æ¬¡æ»‘åŠ¨"""
        if status in ['superlike', 'like', 'dislike']:
            defaults = {'status': status}
            cls.objects.update_or_create(uid=uid, sid=sid, defaults=defaults)

    @classmethod
    def is_liked(cls, uid, sid):
        """æ£€æŸ¥uidæ˜¯å¦å–œæ¬¢sid"""
        return cls.objects.filter(uid=uid, sid=sid,
                                  status__in=['superlike', 'like']).exists()


class Friend(models.Model):
    uid1 = models.IntegerField(verbose_name='ç”¨æˆ·1çš„ UID')
    uid2 = models.IntegerField(verbose_name='ç”¨æˆ·2çš„ UID')

    @classmethod
    def be_friends(cls, uid1, uid2):
        """æˆä¸ºå¥½å‹"""
        uid1, uid2 = (uid1, uid2) if uid1 < uid2 else (uid2, uid1)
        cls.objects.get_or_create(uid1=uid1, uid2=uid2)  # å¦‚æœæœ‰çš„è¯å°±ä¼šå¿½ç•¥æ‰

    @classmethod
    def is_friend(cls, uid1, uid2):
        """æ£€æŸ¥æ˜¯å¦æ˜¯å¥½å‹"""
        condition = Q(uid1=uid1, uid2=uid2) | Q(uid1=uid2, uid2=uid1)
        return cls.objects.filter(condition).exists()

    @classmethod
    def break_off(cls, uid1, uid2):
        """æ–­äº¤"""
        uid1, uid2 = (uid1, uid2) if uid1 < uid2 else (uid2, uid1)
        try:
            cls.objects.get(uid1=uid1, uid2=uid2).delete()
        except cls.DoesNotExist:
            pass

    @classmethod
    def friends(cls,uid):
        condition = Q(uid1=uid) | Q(uid2=uid)
        relations = cls.objects.filter(condition)  # è¿‡æ»¤å‡ºæˆ‘çš„å¥½å‹å…³ç³»
        friend_id_list = []
        for r in relations:
            friend_id = r.uid2 if r.uid1 == uid else r.uid1
            friend_id_list.append(friend_id)
        return User.objects.filter(id__in=friend_id_list)

```

### 4. `swiper/settings.py`

```python
INSTALLED_APPS = [
	...
    'user',
    'social',
]
```

### 5. `swiper/urls.py`

```python
from social import api as social_api
urlpatterns = [
	...

    url('^api/social/users$', social_api.get_users),
    url('^api/social/like$', social_api.like),
    url('^api/social/superlike$', social_api.superlike),
    url('^api/social/dislike$', social_api.dislike),
    url('^api/social/rewind$', social_api.rewind),
]
```

## åä¸€. scriptsæ¨¡å—

> è„šæœ¬æ–‡ä»¶
>
> 1. `init.py `ï¼šåˆå§‹åŒ–ä¸€äº›æ•°æ®å’Œä¸€äº›æœºå™¨äººæ•°æ®ã€‚

### 1. `init.py `

```python
#!/user/bin/env python
# æŒ‡å¯¼è¿™ä¸ªè„šæœ¬æ€ä¹ˆæ‰§è¡Œ
import os
import sys
import random

import django

# è®¾ç½®ç¯å¢ƒï¼ŒåŠ è½½ Django ç¯å¢ƒ
BASE_DIR = os.path.dirname(os.path.dirname(os.path.abspath(__file__)))

sys.path.insert(0, BASE_DIR)
os.environ.setdefault('DJANGO_SETTINGS_MODULE', 'swiper.settings')
django.setup()

# å¦‚æœæ²¡æœ‰ä¸Šé¢ç¯å¢ƒçš„é…ç½®ï¼Œä¸‹é¢çš„ User ä¸ä¼šè¢«åŠ è½½
from user.models import User
from vip.models import Permission, Vip, VipPermRelation

last_names = ('èµµé’±å­™æå‘¨å´éƒ‘ç‹å†¯é™ˆè¤šå«è’‹æ²ˆéŸ©æ¨'
              'æœ±ç§¦å°¤è®¸ä½•å•æ–½å¼ å­”æ›¹ä¸¥åé‡‘é­é™¶å§œ'
              'æˆšè°¢é‚¹å–»æŸæ°´çª¦ç« äº‘è‹æ½˜è‘›å¥šèŒƒå½­éƒ'
              'é²éŸ¦æ˜Œé©¬è‹—å‡¤èŠ±æ–¹ä¿ä»»è¢æŸ³é…†é²å²å”'
              'è´¹å»‰å²‘è–›é›·è´ºå€ªæ±¤æ»•æ®·ç½—æ¯•éƒé‚¬å®‰å¸¸')

first_names = {
    'Male': [
        'æ˜Šç„¶', 'å¤æ›œ', 'è‹±è¾¾', 'æœ¨æ§¿', 'å¤©é’§', 'åèŒ‚', 'é«˜è½©', 'çªç›',
        'æ‰¿å¤©', 'å…‰è¾‰', 'å¤©å®‡', 'å…´å›½', 'å®¸æµ©', 'æ¶¦ç‰', 'æ–¯è¾°', 'æ–‡å“²',
        'ç™½è‰', 'æ¬§è¾°', 'æ‰¿å¿—', 'æš®è¯', 'ä¿Šé‚ˆ', 'é˜³é”¦', 'é»æ‰', 'é¸¿ç•…',
        'ä¿Šè¯­', 'ç‰ä¹¦', 'æ—å¤', 'æ¸…å˜‰', 'æˆ•ä»ª', 'æ™¯æ›œ', 'æ˜•æ™–', 'å®¾é¸¿',
    ],
    'Female': [
        'å®›æ¢¦', 'æ²›ç²', 'ç´«é›¯', 'å©•å¨‡', 'å†‰ç”¯', 'æ·‡æ±', 'å«¦æ›¦', 'é™ç’‡',
        'æ™“æ¢…', 'æ€æ¶µ', 'å¦ç²', 'å¦é’', 'èè¯—', 'æ·‡ç”„', 'ç‘œè±', 'ä¾é™',
        'ç»®èŠ™', 'å¨£ç«¥', 'é¸¿ç¢§', 'ç´«éœœ', 'é‡‘ç³', 'é™ˆçº¢', 'å¹³å¢', 'ç„‰é›¨',
        'ä¸­é¢–', 'å’ªæ¸²', 'è±æ¢“', 'å§æ™¶', 'å‡¡æ·‡', 'å—åª›', 'é›ªå', 'å©•é¸£',
    ]
}


def random_name():
    last_name = random.choice(last_names)
    sex = random.choice(['Male', 'Female'])
    first_name = random.choice(first_names[sex])
    return ''.join([last_name, first_name]), sex


def creat_robots(n):
    # åˆ›å»ºåˆå§‹ç”¨æˆ·
    for i in range(n):
        while True:
            name, sex = random_name()
            try:
                User.objects.get(nickname=name)  # å­˜åœ¨é‡æ–°å¾ªç¯é€‰åå­—
                continue
            except User.DoesNotExist:  # ä¸å­˜åœ¨ä½¿ç”¨æ­¤åå­—
                break
        User.objects.create(
            phonenum='%s' % random.randrange(21000000000, 21900000000),
            nickname=name,
            sex=sex,
            birth_year=random.randint(1980, 2000),
            birth_month=random.randint(1, 12),
            birth_day=random.randint(1, 28),
            location=random.choice(['åŒ—äº¬', 'ä¸Šæµ·', 'æ·±åœ³', 'å¹¿å·', 'è¥¿å®‰', 'æˆéƒ½', 'æ²ˆé˜³', 'æ­¦æ±‰']),
        )
        print('created: %s %s' % (name, sex))


def init_permission():
    """åˆ›å»ºåˆå§‹æƒé™"""
    permissions = [
        'vipflag',
        'superlike',
        'rewind',
        'anylocation',
        'unlimit_like',
    ]
    for name in permissions:
        perm, _ = Permission.objects.get_or_create(name=name)
        print('created permission %s' % perm.name)


def init_vip():
    for i in range(4):
        vip, _ = Vip.objects.get_or_create(
            name='ä¼šå‘˜-%d' % i,
            level=i,
            price=i * 5.0
        )
        print('created %s' % vip.name)


def create_vip_perm_relation():
    """åˆ›å»º Vip å’Œ Permission çš„å…³ç³»"""
    # è·å–VIP
    vip1 = Vip.objects.get(level=1)
    vip2 = Vip.objects.get(level=2)
    vip3 = Vip.objects.get(level=3)

    # è·å–æƒé™
    vipflag = Permission.objects.get(name='vipflag')
    superlike = Permission.objects.get(name='superlike')
    rewind = Permission.objects.get(name='rewind')
    anylocation = Permission.objects.get(name='anylocation')
    unlimit_like = Permission.objects.get(name='unlimit_like')

    # ç»™ VIP 1 åˆ†é…æƒé™
    VipPermRelation.objects.get_or_create(vip_id=vip1.id, perm_id=vipflag.id)
    VipPermRelation.objects.get_or_create(vip_id=vip1.id, perm_id=superlike.id)

    # ç»™ VIP 2 åˆ†é…æƒé™
    VipPermRelation.objects.get_or_create(vip_id=vip2.id, perm_id=superlike.id)
    VipPermRelation.objects.get_or_create(vip_id=vip2.id, perm_id=rewind.id)
    VipPermRelation.objects.get_or_create(vip_id=vip2.id, perm_id=unlimit_like.id)

    # ç»™ VIP 3 åˆ†é…æƒé™
    VipPermRelation.objects.get_or_create(vip_id=vip3.id, perm_id=vipflag.id)
    VipPermRelation.objects.get_or_create(vip_id=vip3.id, perm_id=superlike.id)
    VipPermRelation.objects.get_or_create(vip_id=vip3.id, perm_id=rewind.id)
    VipPermRelation.objects.get_or_create(vip_id=vip3.id, perm_id=anylocation.id)
    VipPermRelation.objects.get_or_create(vip_id=vip3.id, perm_id=unlimit_like.id)


if __name__ == '__main__':
    # creat_robots(1000)
    init_permission()
    init_vip()
    create_vip_perm_relation()

```

## åäºŒ. `vip`æ¨¡å—

### 1. `vip/logic.py`

```python
from common import error
from libs.http import render_json


def perm_require(perm_name):
    """æƒé™æ£€æŸ¥è£…é¥°å™¨"""
    def deco(view_func):
        def wrap(request):
            user = request.user
            # åˆ¤æ–­ç”¨æˆ·æ˜¯å¦æœ‰perm_nameè¿™ä¸ªæƒé™ï¼Œå¦‚æœæœ‰æƒé™æ­£å¸¸æ‰§è¡Œå‡½æ•°å¹¶è¿”å›å€¼ï¼Œå¦‚æœæ²¡æœ‰æƒé™åˆ™è¿”å›é”™è¯¯
            if user.vip.has_perm(perm_name):  
                response = view_func(request)
                return response
            else:
                return render_json(None, error.NOT_HAS_PERM)
        return wrap
    return deco

```

### 2. `vip/models.py`

> å¤šå¯¹å¤šéœ€è¦ä¸‰å¼ è¡¨

```python
"""
Vip - User: ä¸€å¯¹å¤š
Vip - Permission: ä¸€å¯¹å¤š
"""

from django.db import models


class Vip(models.Model):
    """
    ä¼šå‘˜1
    ä¼šå‘˜2
    ä¼šå‘˜3
    """
    name = models.CharField(max_length=32, unique=True)
    level = models.IntegerField()
    price = models.FloatField()

    def perms(self):
        """å½“å‰ VIP å…·æœ‰çš„æ‰€æœ‰æƒé™"""
        relations = VipPermRelation.objects.filter(vip_id=self.id)
        perm_id_list = [r.perm_id for r in relations]
        return Permission.objects.filter(id__in=perm_id_list)

    def has_perm(self, perm_name):
        """æ£€æŸ¥è¿™ä¸ªä¼šå‘˜ç­‰çº§æ˜¯å¦æœ‰æŸç§æƒé™"""
        perm = Permission.objects.get(name=perm_name)
        return VipPermRelation.objects.filter(vip_id=self.id,perm_id=perm.id).exists()


class Permission(models.Model):
    """
    æƒé™è¡¨
        vipflag ä¼šå‘˜èº«ä»½æ ‡è¯†
        superlike è¶…çº§å–œæ¬¢
        rewind è¿”å›åŠŸèƒ½
        anylocation ä»»æ„æ›´æ”¹å®šä½
        unlimit_like æ— é™å–œæ¬¢æ¬¡æ•°
    """

    name = models.CharField(max_length=32, unique=True)


class VipPermRelation(models.Model):
    """"
    ä¼šå‘˜æƒé™å…³ç³»è¡¨
    vip_id       perm_id
    ä¼šå‘˜èº«ä»½æ ‡è¯†  1      3
    è¶…çº§å–œæ¬¢      1  2   3
    è¿”å›åŠŸèƒ½         2   3
    ä»»æ„æ›´æ”¹å®šä½         3
    æ— é™å–œæ¬¢æ¬¡æ•°     2   3
    """
    vip_id = models.IntegerField()
    perm_id = models.IntegerField()

```

### 3. `swiper/settings.py`

```python
INSTALLED_APPS = [
	...
    'user',
    'social',
    'vip',
]
```

## åä¸‰. loggingé…ç½®

[Djangoé…ç½®](https://blog.csdn.net/zhouzhiwengang/article/details/119606262)

[loggingæ¨¡å—ä½¿ç”¨](https://blog.csdn.net/weixin_41010198/article/details/89356417)

### `swiper/settings.py`

> simpleï¼šæ¯”è¾ƒ**ç®€å•**çš„æ—¥å¿—ä¿¡æ¯æ ¼å¼ï¼Œinfo Handlerä½¿ç”¨ã€‚
>
> verboseï¼šæ¯”è¾ƒ**è¯¦ç»†**çš„æ—¥å¿—ä¿¡æ¯æ ¼å¼ï¼Œerror Handlerä½¿ç”¨ã€‚

```python
# æ—¥å¿—é…ç½®
LOGGING = {
    'version': 1,
    'disable_existing_loggers': True,
    # æ ¼å¼é…ç½®
    'formatters': {
        'simple': {
            "format": '%(asctime)s %(module)s.%(funcName)s:%(message)s',
            "datefmt": "%Y-%m-%d %H:%M:%S"
        },
        'verbose': {
            "format": '%(asctime)s %(levelname)s [%(process)d-%(threadName)s] '
                      '%(module)s:%(funcName)s line %(lineno)d:%(message)s',
            "datefmt": "%Y-%m-%d %H:%M:%S"
        }
    },
    # Handler é…ç½®
    'handlers': {
        'console': {
            'level': 'DEBUG' if DEBUG else 'WARNING',
            'class': 'logging.StreamHandler',
        },
        'info': {
            'level': 'INFO',
            'class': 'logging.handlers.TimedRotatingFileHandler',
            ''
            'filename': os.path.join(BASE_DIR, 'logs/info.log'),  # æ—¥å¿—ä¿å­˜è·¯å¾„
            'when': "D",  # æ¯æ—¥åˆ‡å‰²æ—¥å¿—
            'backupCount': 30,  # æ—¥å¿—ä¿ç•™30å¤©
            'formatter': 'simple',
            'encoding': 'utf-8',  # ä¸­æ–‡ä¸ä¹±ç 
        },
        "error": {
            'level': 'WARNING',
            'class': 'logging.handlers.TimedRotatingFileHandler',
            'filename': os.path.join(BASE_DIR, 'logs/error.log'),  # æ—¥å¿—ä¿å­˜è·¯å¾„
            'when': "W0",  # æ¯å‘¨åˆ‡å‰²æ—¥å¿—
            'backupCount': 4,  # æ—¥å¿—ä¿ç•™4å‘¨
            'formatter': 'verbose',
            'encoding': 'utf-8',  # ä¸­æ–‡ä¸ä¹±ç 
        }
    },
    # Logger é…ç½®
    'loggers': {
        'django': {
            'handlers': ['console'],
        },
        "inf": {
            "level": "INFO",
            "handlers": ["info"],
            'propagate': True,
        },
        "err": {
            "level": "WARNING",
            "handlers": ["error"],
            'propagate': True,
        }
    }
}
```

## åå››. ç¼“å­˜å¤„ç†

> memcached
>
> + æ“ä½œ
>   + set
>   + get
>   + incr
>   + decr
>   + watch
> + ä¼˜ç‚¹ï¼šæ€§èƒ½å¥½
> + ç¼ºç‚¹ï¼šæ— æ³•åšåˆ°æ•°æ®æŒä¹…åŒ–ä¿å­˜ï¼Œåªç”¨åˆ°äº†å†…å­˜ï¼Œä¸€æ—¦å®•æœºæ•°æ®ä¼šå…¨éƒ¨æ¶ˆå¤±ã€‚
>
> redis

[django cache](https://docs.djangoproject.com/en/4.1/topics/cache/)

[django session é…ç½®](https://blog.csdn.net/weixin_42194215/article/details/111414823)

```
pip install django-redis
```

### `swiper/settings.py`

```python
# ä½¿ç”¨ redis åšç¼“å­˜
CACHES = {
    'default': {
        'BACKEND': 'django_redis.cache.RedisCache',
        'LOCATION': 'redis://127.0.0.1:6379/4',
        'OPTIONS': {
            'CLIENT_CLASS': 'django_redis.client.DefaultClient',
            'PICKLE_VERSION': -1,
        }
    },
    "session": {
        "BACKEND": "django_redis.cache.RedisCache",
        "LOCATION": "redis://127.0.0.1:6379/2",		# å°†sessionè®¾ç½®åœ¨1å·åº“ä¸­
        "OPTIONS": {
            "CLIENT_CLASS": "django_redis.client.DefaultClient",
            "CONNECTION_POOL_KWARGS": {"max_connections": 100}
            # "PASSWORD": "123",
        }
    }
}
# sessionçš„å­˜å‚¨é…ç½®
SESSION_ENGINE = 'django.contrib.sessions.backends.cache'
SESSION_CACHE_ALIAS = 'session'		# ä¸Šé¢ CACHES ä¸­è®¾ç½®çš„åç§°
SESSION_COOKIE_AGE = 60 * 60 * 24 * 30  # è®¾ç½®sessionå¤±æ•ˆæ—¶é—´ä¸º30å¤©å, å•ä½ä¸ºç§’S
```

### ä¸€èˆ¬ç¼“å­˜å¤„ç†æµç¨‹

```python
from django.core.cache import cache

user_profile = cache.get(key)  # é¦–å…ˆä»ç¼“å­˜ä¸­è·å–æ•°æ®
if not user_profile:
    user_profile = user.profile.to_dict()  # ç¼“å­˜ä¸­æ²¡æœ‰ï¼Œä»æ•°æ®åº“ä¸­è·å–
    cache.set(key, user_profile)  # å°†æ•°æ®æ·»åŠ åˆ°ç¼“å­˜ï¼Œæ–¹ä¾¿ä¸‹æ¬¡è·å–
return render_json(user_profile)
```

### `swiper/_init_.py`

```python
from libs.db import patch_model

# åŠ¨æ€ç»™åŸç”Ÿçš„ Model æ‰“è¡¥ä¸ï¼Œéœ€è¦æŠ¢åœ¨modelsä»£ç åŠ è½½ä¹‹å‰åŠ è½½ï¼Œæ‰€ä»¥å†™åœ¨settingså‰é¢
patch_model()
```

## åäº”. åˆ†å¸ƒå¼æ•°æ®åº“

> æ•°æ®æ€»é‡ï¼š 5000w
>
> å•å°èƒ½åŠ›ä¸Šé™ï¼š500w
>
> æ•°æ®åˆ†ç‰‡ï¼šsharding
>
> Userè¡¨ï¼š
>
> user_0	  		1	-	500 w
>
> user_1	  500 w	-	1000 w
>
> user_2	1000 w	-	1500 w
>
> user_3	1500 w	-	2000 w
>
> user_4	2000 w	-	3500 w
>
> user_5	2500 w	-	3000 w
>
> user_6	3000 w	-	3500 w
>
> user_7	3500 w	-	4000 w
>
> user_8	4000 w	-	4500 w
>
> user_9	4500 w	-	5000 w



> user_0	  1		11		...
>
> user_1	  2		12		...
>
> user_2	  3		13		...
>
> user_3	  4	    14		...
>
> user_4	  5		15		...
>
> user_5	  6		16		...
>
> user_6	  7		17		...
>
> user_7	  8		18		...
>
> user_8	  9		19		...
>
> user_9	10		20		...
>
> â€‹	master	<-	å†™å…¥
>
> â€‹	slave		->	è¯»å–
>
> â€‹	slave		->	è¯»å–
>
> â€‹	slave		->	è¯»å–
>
> è¯»å†™åˆ†ç¦»
>
> zookeeper

Django é…ç½®mysql

```
pip install pymysql
```

### `swiper/settings`

```python
DATABASES = {
    'default':
        {
            'ENGINE': 'django.db.backends.mysql',  # æ•°æ®åº“å¼•æ“
            'NAME': 'swiper',  # æ•°æ®åº“åç§°
            'HOST': '82.157.36.220',  # æ•°æ®åº“åœ°å€
            'PORT': 3306,  # mysqlç«¯å£
            'USER': 'root',  # æ•°æ®åº“ç”¨æˆ·å
            'PASSWORD': '123456',  # æ•°æ®åº“å¯†ç 
        }
}
```

### `swiper/_init_.py`

```python
import pymysql
pymysql.install_as_MySQLdb()
```

